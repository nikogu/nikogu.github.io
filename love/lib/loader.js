function proxy(fn,context){return function(){fn.apply(context,arguments)}}window.Loader=function(){this.manifest=[];this.loadCount=0;this.res={};this._onprogress=function(){};this._onload=function(){}};(function(){var p=Loader.prototype;p.add=function(arg1,arg2){if(arg2){this.manifest.push({id:arg1,url:arg2})}else{for(var prop in arg1){this.manifest.push({id:prop,url:arg1[prop]})}}};p._load=function(){for(var i=this.resNum;i--;){this.res[this.manifest[i].id]={url:this.manifest[i].url,width:0,height:0};if(this.isAudio(this.res[this.manifest[i].id])){(proxy(function(i){this._loadAudio(i)},this))(i)}else{(proxy(function(i){this._loadImg(i)},this))(i)}}};p._loadProgress=function(){this.loadCount++;this._onprogress.call(this,{totalNum:this.resNum,currentNum:this.loadCount-1,currentRes:this.manifest[this.loadCount-1]});if(this.loadCount===this.resNum){this._onload.call(this,this.res)}};p._loadAudio=function(i){try{var audio=new Audio();this.res[this.manifest[i].id].audio=audio;audio.addEventListener("canplay",proxy(function(){this._loadProgress()},this));if(/\.mp3$/.test(this.manifest[i].url)){audio.innerHTML='<source src="'+this.manifest[i].url+'" type="audio/mpeg">'}else{if(/\.wav$/.test(this.manifest[i].url)){audio.innerHTML='<source src="'+this.manifest[i].url+'" type="audio/wav">'}else{if(/\.ogg$/.test(this.manifest[i].url)){audio.innerHTML='<source src="'+this.manifest[i].url+'" type="audio/ogg">'}else{audio.src=this.manifest[i].url}}}}catch(e){throw new Error(this.manifest[i].url+" load fail");this._loadProgress()}};p._loadImg=function(i){try{var img=new Image();this.res[this.manifest[i].id].image=img;img.onload=proxy(function(){this.res[this.manifest[i].id].width=img.width;this.res[this.manifest[i].id].height=img.height;this._loadProgress()},this);img.src=this.manifest[i].url}catch(e){throw new Error(this.manifest[i].url+" load fail");this._loadProgress()}};p.load=function(){this.resNum=this.manifest.length;this._load()};p.isAudio=function(res){return/\.mp3$|\.ogg$|\.wav$/.test(res.url)};p.onprogress=function(callback){this._onprogress=callback};p.onload=function(callback){this._onload=callback}})();